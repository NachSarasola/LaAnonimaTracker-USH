# La Anónima Price Tracker Configuration
# ======================================

# Branch Configuration
# -------------------
branch:
  postal_code: "9410"
  branch_name: "USHUAIA 5"
  branch_id: "75"  # Internal ID for the branch
  province: "Tierra del Fuego"
  city: "Ushuaia"

# Website Configuration
# ---------------------
website:
  base_url: "https://www.laanonima.com.ar/"
  search_url: "https://www.laanonima.com.ar/buscar/{query}"
  timeout: 30000  # milliseconds
  retry_attempts: 3
  retry_delay: 2  # seconds
  headless: true

# Canonical business categories (rubros)
# -------------------------------------
canonical_categories:
  labels:
    almacen: "Almacén"
    bebidas: "Bebidas"
    lacteos: "Lácteos"
    carniceria: "Carnicería"
    congelados: "Congelados"
    frutas_y_verduras: "Frutas y Verduras"
    perfumeria: "Perfumería"
    limpieza: "Limpieza"
    mascotas: "Mascotas"
  aliases:
    almacen: ["panaderia", "legumbres", "aceites", "azucar", "condimentos", "conservas", "huevos"]
    bebidas: ["bebidas", "bebidas_alcoholicas"]
    lacteos: ["lacteos"]
    carniceria: ["carnes"]
    congelados: ["congelados"]
    frutas_y_verduras: ["frutas", "verduras"]
    perfumeria: ["higiene", "perfumeria"]
    limpieza: ["limpieza"]
    mascotas: ["mascotas"]

# Basket Definitions
# ------------------
# Basket A: INDEC Canasta Básica Alimentaria (CBA)
# Based on official INDEC product list for Greater Buenos Aires
# Adapted for availability at La Anónima

baskets:
  # Basket A: INDEC CBA - Essential food basket
  cba:
    name: "Canasta Básica Alimentaria (INDEC)"
    description: "Official INDEC basic food basket for poverty line measurement"
    base_period: "2024-01"
    items:
      # Panadería (Bakery)
      - id: "cba_pan_fam"
        name: "Pan flauta/familia"
        keywords: ["pan flauta", "pan familia"]
        category: "panaderia"
        unit: "kg"
        quantity: 4.5
        matching: "loose"
        
      - id: "cba_galletitas"
        name: "Galletitas de agua"
        keywords: ["galletitas agua", "galletas agua"]
        brand_hint: ["Terrabusi", "Bagley", "Don Satur"]
        category: "panaderia"
        unit: "paquete"
        quantity: 3
        matching: "loose"
        
      # Carnes (Meat)
      - id: "cba_bife"
        name: "Bife de chorizo"
        keywords: ["bife chorizo", "bife angosto"]
        category: "carnes"
        unit: "kg"
        quantity: 2
        matching: "loose"
        
      - id: "cba_carne_picada"
        name: "Carne picada común"
        keywords: ["carne picada", "picada comun"]
        category: "carnes"
        unit: "kg"
        quantity: 1.5
        matching: "loose"
        
      - id: "cba_pollo"
        name: "Pollo entero"
        keywords: ["pollo entero", "pollo fresco"]
        category: "carnes"
        unit: "kg"
        quantity: 3
        matching: "loose"
        
      - id: "cba_paleta"
        name: "Paleta de cerdo"
        keywords: ["paleta cerdo", "paleta de cerdo"]
        category: "carnes"
        unit: "kg"
        quantity: 1.5
        matching: "loose"
        
      # Lácteos (Dairy)
      - id: "cba_leche"
        name: "Leche fluida entera"
        keywords: ["leche entera", "leche fluida"]
        brand_hint: ["La Serenísima", "Verónica", "Sancor"]
        category: "lacteos"
        unit: "litro"
        quantity: 6
        matching: "loose"
        
      - id: "cba_queso_cremoso"
        name: "Queso cremoso"
        keywords: ["queso cremoso", "queso fresco"]
        category: "lacteos"
        unit: "kg"
        quantity: 1.2
        matching: "loose"
        
      - id: "cba_queso_rallado"
        name: "Queso rallado"
        keywords: ["queso rallado", "rallado"]
        category: "lacteos"
        unit: "kg"
        quantity: 0.15
        matching: "loose"
        
      - id: "cba_manteca"
        name: "Manteca"
        keywords: ["manteca", "mantequilla"]
        brand_hint: ["La Serenísima", "Sancor", "Milkaut"]
        category: "lacteos"
        unit: "kg"
        quantity: 0.3
        matching: "loose"
        
      - id: "cba_yogur"
        name: "Yogur bebible"
        keywords: ["yogur bebible", "yogur drink"]
        category: "lacteos"
        unit: "litro"
        quantity: 3
        matching: "loose"
        
      # Huevos
      - id: "cba_huevos"
        name: "Huevos"
        keywords: ["huevos", "huevo"]
        category: "huevos"
        unit: "docena"
        quantity: 2
        matching: "loose"
        
      # Aceite y grasas
      - id: "cba_aceite"
        name: "Aceite de girasol"
        keywords: ["aceite girasol", "aceite de girasol"]
        brand_hint: ["Natura", "Cocinero"]
        category: "aceites"
        unit: "litro"
        quantity: 1.5
        matching: "loose"
        
      # Azúcar y dulces
      - id: "cba_azucar"
        name: "Azúcar"
        keywords: ["azucar", "azúcar"]
        category: "azucar"
        unit: "kg"
        quantity: 2
        matching: "loose"
        
      - id: "cba_dulce_leche"
        name: "Dulce de leche"
        keywords: ["dulce leche", "dulce de leche"]
        brand_hint: ["La Serenísima", "Sancor", "Milkaut"]
        category: "azucar"
        unit: "kg"
        quantity: 0.5
        matching: "loose"
        
      - id: "cba_mermelada"
        name: "Mermelada"
        keywords: ["mermelada", "jalea"]
        category: "azucar"
        unit: "kg"
        quantity: 0.3
        matching: "loose"
        
      # Bebidas
      - id: "cba_yerba"
        name: "Yerba mate"
        keywords: ["yerba mate", "yerba"]
        brand_hint: ["Taragüi", "Amanda", "Rosamonte", "La Tranquera"]
        category: "bebidas"
        unit: "kg"
        quantity: 2
        matching: "loose"
        
      - id: "cba_cafe"
        name: "Café molido"
        keywords: ["cafe molido", "café molido"]
        brand_hint: ["Nescafé", "Arlistán", "La Virginia"]
        category: "bebidas"
        unit: "kg"
        quantity: 0.25
        matching: "loose"
        
      - id: "cba_te"
        name: "Té en saquitos"
        keywords: ["te saquitos", "té saquitos", "te en saquitos"]
        brand_hint: ["Taragüi", "La Virginia", "Green Hills"]
        category: "bebidas"
        unit: "caja"
        quantity: 1
        matching: "loose"
        
      # Arroz, pastas y legumbres
      - id: "cba_arroz"
        name: "Arroz"
        keywords: ["arroz", "arroz largo"]
        category: "legumbres"
        unit: "kg"
        quantity: 1.5
        matching: "loose"
        
      - id: "cba_fideos"
        name: "Fideos secos"
        keywords: ["fideos", "fideo", "espagueti", "tallarin"]
        brand_hint: ["Terrabusi", "Matarazzo", "Lucchetti"]
        category: "legumbres"
        unit: "kg"
        quantity: 2
        matching: "loose"
        
      - id: "cba_porotos"
        name: "Porotos"
        keywords: ["porotos", "frijoles", "poroto"]
        category: "legumbres"
        unit: "kg"
        quantity: 0.3
        matching: "loose"
        
      - id: "cba_lentejas"
        name: "Lentejas"
        keywords: ["lentejas", "lenteja"]
        category: "legumbres"
        unit: "kg"
        quantity: 0.3
        matching: "loose"
        
      # Verduras y frutas (fresh produce - may be limited online)
      - id: "cba_papa"
        name: "Papas"
        keywords: ["papa", "papas"]
        category: "verduras"
        unit: "kg"
        quantity: 3
        matching: "loose"
        
      - id: "cba_cebolla"
        name: "Cebolla"
        keywords: ["cebolla", "cebollas"]
        category: "verduras"
        unit: "kg"
        quantity: 1.5
        matching: "loose"
        
      - id: "cba_zanahoria"
        name: "Zanahoria"
        keywords: ["zanahoria", "zanahorias"]
        category: "verduras"
        unit: "kg"
        quantity: 1.5
        matching: "loose"
        
      - id: "cba_tomate"
        name: "Tomate"
        keywords: ["tomate", "tomates"]
        category: "verduras"
        unit: "kg"
        quantity: 2.5
        matching: "loose"
        
      - id: "cba_lechuga"
        name: "Lechuga"
        keywords: ["lechuga", "lechugas"]
        category: "verduras"
        unit: "kg"
        quantity: 1
        matching: "loose"
        
      - id: "cba_manzana"
        name: "Manzana"
        keywords: ["manzana", "manzanas"]
        category: "frutas"
        unit: "kg"
        quantity: 2
        matching: "loose"
        
      - id: "cba_naranja"
        name: "Naranja"
        keywords: ["naranja", "naranjas"]
        category: "frutas"
        unit: "kg"
        quantity: 2
        matching: "loose"
        
      - id: "cba_banana"
        name: "Banana"
        keywords: ["banana", "bananas", "plátano"]
        category: "frutas"
        unit: "kg"
        quantity: 2
        matching: "loose"
        
      # Sal y condimentos
      - id: "cba_sal"
        name: "Sal fina"
        keywords: ["sal fina", "sal de mesa"]
        category: "condimentos"
        unit: "kg"
        quantity: 0.3
        matching: "loose"
        
      - id: "cba_mayonesa"
        name: "Mayonesa"
        keywords: ["mayonesa"]
        brand_hint: ["Hellmann's", "Natura", "Heinz"]
        category: "condimentos"
        unit: "kg"
        quantity: 0.3
        matching: "loose"
        
      # Bebidas alcohólicas (wine for CBT)
      - id: "cba_vino"
        name: "Vino común"
        keywords: ["vino común", "vino mesa", "vino tinto"]
        category: "bebidas_alcoholicas"
        unit: "litro"
        quantity: 1.5
        matching: "loose"

  # Basket B: Extended Products
  extended:
    name: "Extended Product Basket"
    description: "Additional products for comprehensive price tracking"
    items:
      - id: "ext_harina"
        name: "Harina de trigo 000"
        keywords: ["harina 000", "harina trigo"]
        category: "panaderia"
        unit: "kg"
        quantity: 4
        matching: "loose"
        
      - id: "ext_aceite_oliva"
        name: "Aceite de oliva"
        keywords: ["aceite oliva", "aceite de oliva"]
        category: "aceites"
        unit: "litro"
        quantity: 0.5
        matching: "loose"
        
      - id: "ext_azucar_morena"
        name: "Azúcar morena"
        keywords: ["azucar morena", "azúcar morena"]
        category: "azucar"
        unit: "kg"
        quantity: 1
        matching: "loose"
        
      - id: "ext_galletas_dulces"
        name: "Galletitas dulces"
        keywords: ["galletitas dulces", "galletas dulces", "cookies"]
        category: "panaderia"
        unit: "paquete"
        quantity: 2
        matching: "loose"
        
      - id: "ext_jugo"
        name: "Jugo en polvo"
        keywords: ["jugo polvo", "jugo en polvo", "refresco"]
        brand_hint: ["Tang", "Clight"]
        category: "bebidas"
        unit: "sobre"
        quantity: 6
        matching: "loose"
        
      - id: "ext_gaseosa"
        name: "Gaseosa"
        keywords: ["gaseosa", "refresco", "soda"]
        brand_hint: ["Coca-Cola", "Pepsi", "Sprite"]
        category: "bebidas"
        unit: "litro"
        quantity: 3
        matching: "loose"
        
      - id: "ext_atun"
        name: "Atún en lata"
        keywords: ["atun lata", "atún en lata"]
        category: "conservas"
        unit: "lata"
        quantity: 2
        matching: "loose"
        
      - id: "ext_arvejas"
        name: "Arvejas en lata"
        keywords: ["arvejas lata", "arvejas en lata"]
        category: "conservas"
        unit: "lata"
        quantity: 2
        matching: "loose"
        
      - id: "ext_choclo"
        name: "Choclo en lata"
        keywords: ["choclo lata", "choclo en lata", "maíz dulce"]
        category: "conservas"
        unit: "lata"
        quantity: 2
        matching: "loose"
        
      - id: "ext_pure_tomate"
        name: "Puré de tomate"
        keywords: ["pure tomate", "puré de tomate"]
        category: "conservas"
        unit: "lata"
        quantity: 3
        matching: "loose"
        
      - id: "ext_shampoo"
        name: "Shampoo"
        keywords: ["shampoo", "shampoo"]
        category: "higiene"
        unit: "unidad"
        quantity: 1
        matching: "loose"
        
      - id: "ext_jabon"
        name: "Jabón de tocador"
        keywords: ["jabon tocador", "jabón de tocador"]
        category: "higiene"
        unit: "unidad"
        quantity: 3
        matching: "loose"
        
      - id: "ext_pasta_dental"
        name: "Pasta dental"
        keywords: ["pasta dental", "dentifrico", "dentífrico"]
        category: "higiene"
        unit: "unidad"
        quantity: 1
        matching: "loose"
        
      - id: "ext_desodorante"
        name: "Desodorante"
        keywords: ["desodorante"]
        category: "higiene"
        unit: "unidad"
        quantity: 1
        matching: "loose"
        
      - id: "ext_papel_higienico"
        name: "Papel higiénico"
        keywords: ["papel higienico", "papel higiénico"]
        category: "limpieza"
        unit: "unidad"
        quantity: 6
        matching: "loose"
        
      - id: "ext_detergente"
        name: "Detergente"
        keywords: ["detergente", "jabón lavarropa"]
        category: "limpieza"
        unit: "unidad"
        quantity: 1
        matching: "loose"
        
      - id: "ext_lavandina"
        name: "Lavandina"
        keywords: ["lavandina", "blanqueador"]
        category: "limpieza"
        unit: "litro"
        quantity: 1
        matching: "loose"

# Storage Configuration
# ---------------------
storage:
  # Options: sqlite, postgresql
  default_backend: "sqlite"
  
  sqlite:
    database_path: "data/laanonima_prices.db"
    
  postgresql:
    # Preferred for managed providers (Neon/Supabase/Render):
    # set DB_URL env var to full SQLAlchemy URL.
    url: "${DB_URL:}"
    host: "${DB_HOST:localhost}"
    port: "${DB_PORT:5432}"
    database: "${DB_NAME:laanonima_tracker}"
    user: "${DB_USER:tracker}"
    password: "${DB_PASSWORD:}"
    
  exports:
    csv_path: "data/exports/csv"
    parquet_path: "data/exports/parquet"

# Scraping Configuration
# ----------------------
scraping:
  # Delay between requests (milliseconds)
  request_delay: 1000
  
  # Max products to check per search
  max_results_per_search: 12
  # Minimo de candidatos por busqueda (barato/medio/caro)
  min_candidates_per_product: 3
  # Umbral minimo de confianza para guardar match representativo
  min_match_confidence: 0.2
  # Timeouts livianos para parseo/listado
  quick_selector_timeout_ms: 250
  search_settle_delay_ms: 700
  branch_selection:
    strategy: "cp_query_first"  # cp_query_first|modal_only|auto
    probe_timeout_ms: 6000

  # Candidate persistence strategy (prepara modo futuro de guardar 3)
  candidates:
    storage_mode: "db"     # json|db|off
    min_candidates_per_product: 3

  # Performance tuning defaults (compatible with legacy keys above)
  performance:
    commit_batch_size: 12
    base_request_delay_ms: 550
    search_settle_delay_ms: 250
    fail_fast_min_attempts: 8
    fail_fast_fail_ratio: 0.85

  # Deterministic basket planning for efficient runs
  planning:
    profile_default: "balanced"          # balanced|full|cba_only
    runtime_budget_minutes: 20
    rotation_items_default: 4
    lookback_runs: 10
    overhead_seconds: 90
    daily_core_ids:
      - "ext_harina"
      - "ext_pure_tomate"
      - "ext_atun"
      - "ext_gaseosa"
      - "ext_shampoo"
      - "ext_jabon"
      - "ext_pasta_dental"
      - "ext_papel_higienico"
      - "ext_detergente"
      - "ext_lavandina"
    daily_rotation_ids:
      - "ext_aceite_oliva"
      - "ext_azucar_morena"
      - "ext_galletas_dulces"
      - "ext_jugo"
      - "ext_arvejas"
      - "ext_choclo"
      - "ext_desodorante"
  
  # Browser settings
  browser:
    headless: true
    viewport:
      width: 1920
      height: 1080
    user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
    
  # Selectors (may need updating if site changes)
  selectors:
    branch_trigger: "[data-toggle='codigo-postal']"
    postal_input: "#idCodigoPostalUnificado"
    branch_options: "#opcionesSucursal"
    branch_radio: "input[name='sucursalSuper']"
    confirm_button: "#btn_setSucursalSuper"
    current_branch_label: ".sucursal"
    search_input: "#idBuscarProducto"
    search_button: ".btn-buscar"
    product_list: ".producto-item"
    product_name: ".titulo"
    product_price: ".precio"
    product_price_old: ".precio-anterior"
    product_unit_price: ".precio-unitario"
    product_url: "a[href*='producto'], a[href*='art_']"
    product_image: "img"
    out_of_stock: ".sin-stock"
    
# Scheduling Configuration
# ------------------------
scheduling:
  # Cron expression for GitHub Actions
  # Runs on 1st and 15th of each month at 9:00 AM ART (Argentina Time)
  cron_expression: "0 12 1,15 * *"
  
  # Alternative: specific days
  run_days: [1, 15]
  run_time: "09:00"
  timezone: "America/Argentina/Buenos_Aires"

# Analysis Configuration
# ----------------------
analysis:
  # Base period for index calculation (YYYY-MM)
  base_period: "2024-01"
  
  # Index type: laspeyres, paasche, or fisher
  index_type: "laspeyres"
  
  # CPI comparison file path (CSV format)
  cpi_file: "data/cpi/ipc_indec.csv"
  
  # Output settings
  output_dir: "data/analysis"
  plots_dir: "data/analysis/plots"
  reports_dir: "data/analysis/reports"

  # Data quality controls
  validation:
    min_coverage_rate: 0.70
    max_price_jump_pct: 200

  # Tracker-owned IPC methodology (monthly, robust, fixed weights)
  ipc_tracker:
    method_version: "v1_fixed_weight_robust_monthly"
    monthly_aggregation: "winsorized_mean"
    winsor_limits: [0.1, 0.9]
    min_obs_per_product_month: 1
    coverage_min_weight_pct: 0.7
    provisional_freeze_days: 7

  # Official IPC sync strategy (INDEC Nivel4 + XLS/PDF hybrid)
  ipc_official:
    source_mode: "xls_pdf_hybrid"       # xls_pdf_hybrid | fallback | auto_with_fallback
    source_code: "indec_patagonia"
    region_default: "patagonia"
    region_scope: ["patagonia", "nacional"]
    discovery_url: "https://www.indec.gob.ar/Nivel4/Tema/3/5/31"
    fallback_file: "data/cpi/ipc_indec_patagonia.csv"
    pdf_validation_policy: "on_new_month"   # always | on_new_month | never
    validation:
      max_abs_diff_pp: 0.10
    auto_source:
      url: "data/cpi/ipc_indec_patagonia.csv"
      format: "csv"                     # csv | json
      timeout_seconds: 20

  # Canonical app category -> INDEC Cuadro 1 division (strict mapping)
  ipc_category_mapping:
    app_to_indec_division:
      almacen: "alimentos_y_bebidas_no_alcoholicas"
      lacteos: "alimentos_y_bebidas_no_alcoholicas"
      carniceria: "alimentos_y_bebidas_no_alcoholicas"
      congelados: "alimentos_y_bebidas_no_alcoholicas"
      frutas_y_verduras: "alimentos_y_bebidas_no_alcoholicas"
      bebidas: "alimentos_y_bebidas_no_alcoholicas"
      limpieza: "equipamiento_y_mantenimiento_del_hogar"
      perfumeria: "bienes_y_servicios_varios"
      mascotas: null
    # Legacy alias consumed by older code paths; kept for compatibility.
    map:
      almacen: "alimentos_y_bebidas_no_alcoholicas"
      lacteos: "alimentos_y_bebidas_no_alcoholicas"
      carniceria: "alimentos_y_bebidas_no_alcoholicas"
      congelados: "alimentos_y_bebidas_no_alcoholicas"
      frutas_y_verduras: "alimentos_y_bebidas_no_alcoholicas"
      bebidas: "alimentos_y_bebidas_no_alcoholicas"
      limpieza: "equipamiento_y_mantenimiento_del_hogar"
      perfumeria: "bienes_y_servicios_varios"
  
# Logging Configuration
# ---------------------
logging:
  level: "INFO"
  format: "{time:YYYY-MM-DD HH:mm:ss} | {level} | {name} | {message}"
  file: "data/logs/tracker.log"
  rotation: "1 week"
  retention: "1 month"

# Static web publication (low-cost public website mode)
# -----------------------------------------------------
deployment:
  mode: "static_first"              # static_first | api_first
  output_dir: "public"
  public_base_url: "${PUBLIC_BASE_URL:https://preciosushuaia.com}"
  contact_email: "${PUBLIC_CONTACT_EMAIL:hola@preciosushuaia.com}"
  default_region: "patagonia"
  keep_history_months: 24
  fresh_max_hours: 36
  # Daily run reference time in UTC (06:10 ART ~= 09:10 UTC)
  schedule_utc: "09:10"

# Advertising placeholders
# ------------------------
ads:
  enabled: false                    # set true in production website
  provider: "adsense"
  client_id: "${ADSENSE_CLIENT_ID:ca-pub-xxxxxxxxxxxxxxxx}"
  # Legacy compatibility key (still read by code paths).
  client_id_placeholder: "ca-pub-xxxxxxxxxxxxxxxx"
  slots:
    - "header"
    - "inline"
    - "sidebar"
    - "footer"

# Analytics (privacy-first by default)
# ------------------------------------
analytics:
  plausible:
    enabled: false
    domain: "${PLAUSIBLE_DOMAIN:}"
    script_url: "https://plausible.io/js/script.js"

# Premium roadmap placeholders (no paywall yet)
# ---------------------------------------------
premium_placeholders:
  enabled: false
  features:
    - "Alertas de precio personalizadas"
    - "Descarga avanzada CSV/API"
    - "Comparador multi-zona"
    - "Panel Pro sin anuncios"
